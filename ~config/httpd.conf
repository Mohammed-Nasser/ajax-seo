#
# Apache performance tuning resources
#   http://httpd.apache.org/docs/trunk/misc/perf-tuning.html
#   http://www.devside.net/articles/apache-performance-tuning
#   http://virtualmin.com/documentation/system/low-memory
#

Timeout              45
MaxKeepAliveRequests 60
KeepAliveTimeout     2
ServerTokens         Prod

# Change this to Listen on specific IP addresses
Listen 127.0.0.1:80

LoadModule deflate_module   modules/mod_deflate.so
LoadModule expires_module   modules/mod_expires.so
LoadModule filter_module    modules/mod_filter.so
LoadModule headers_module   modules/mod_headers.so
LoadModule http2_module     modules/mod_http2.so
LoadModule mime_module      modules/mod_mime.so
LoadModule rewrite_module   modules/mod_rewrite.so
LoadModule setenvif_module  modules/mod_setenvif.so

ExtendedStatus Off

<Directory />
    # Deny access to the entirety filesystem
    Options None
    AllowOverride None
    Require all denied
    <IfModule rewrite_module>
        RewriteEngine Off
    </IfModule>
</Directory>

# DocumentRoot "/www"

<IfModule rewrite_module>
    # RewriteMap to rewrite uppercase letter URL to lowercase
    RewriteMap lc int:tolower
</IfModule>

DirectorySlash Off

<Directory /www/*>
    # +FollowSymLinks must be enabled for turning on the rewrite engine
    Options None +FollowSymlinks -MultiViews

    # AllowOverride controls what directives may be placed in .htaccess files.
    # AllowOverride is only available in <Directory> sections without regular expressions
    # http://httpd.apache.org/docs/current/mod/core.html#AllowOverride
    # Fix ".htaccess: Option MultiViews not allowed here" https://mathiasbynens.be/notes/apache-allowoverride-all
    #
    AllowOverride FileInfo Indexes Limit Options=All,MultiViews

    # Allow only specific access methods, no OPTIONS HTTP https://www.mnot.net/blog/2012/10/29/NO_OPTIONS
    # OPTIONS method is used by CORS https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
    #
    Require method GET POST
    # <LimitExcept GET POST>
    #     Require all denied
    # </LimitExcept>

    # Enable rewrite_module
    <IfModule rewrite_module>
        RewriteEngine On
    </IfModule>
</Directory>
<Directory /www/*/*>
    # Run .htaccess only from DocumentRoot
    AllowOverride None
</Directory>

#
# Avoid DDoS attacks
# Determine maximum number of internal redirects and nested subrequests
#
LimitInternalRecursion 5
LimitRequestBody       102400
LimitRequestFields     50
LimitRequestFieldSize  1024
# phpMyAdmin get_scripts.js.php long URL compatibility
LimitRequestLine       2047
LimitXMLRequestBody    102400

TraceEnable off

<IfModule dir_module>
    DirectoryIndex index.php index.html
</IfModule>

<IfModule log_config_module>
    <IfModule setenvif_module>
        # Do not log localhost
        SetEnvIf Remote_Addr 127\.0\.0\.1 nolog
        # SetEnvIf Remote_Addr ::1 nolog
        # Do not log various assets
        SetEnvIf Request_URI \.(appcache|crx|css|eot|gif|ico|jpe?g|js|mp4|oga|ogg|ogv|otf|pdf|png|svg|ttf|txt|vcard|vcf|nex|webapp|webm|webmanifest|webp|woff|woff2|xml|xsl)$ nolog
    </IfModule>
    CustomLog "logs/access_log" combined env=!nolog
</IfModule>

<IfModule mime_module>
    # Force UTF-8 for certain file types
    AddCharset utf-8 .appcache .css .js .json .vcard .vcf .vtt .webapp .webmanifest .xml .xsl

    # Proper MIME type
    AddType application/font-sfnt               otf ttf
    AddType application/font-woff               woff
    AddType application/font-woff2              woff2
    AddType application/javascript              js
    AddType application/json                    json
    # Manifest https://w3c.github.io/manifest/#h-media-type-registration, https://bugzilla.mozilla.org/show_bug.cgi?id=997779
    AddType application/manifest+json           webmanifest
    AddType application/vnd.ms-fontobject       eot
    # Chrome add-on https://developer.chrome.com/extensions/hosting
    AddType application/x-chrome-extension      crx
    # Opera add-on https://dev.opera.com/blog/introducing-nex/
    AddType application/x-navigator-extension   nex
    # Firefox Manifest https://developer.mozilla.org/en-US/Apps/Build/Manifest
    AddType application/x-web-app-manifest+json webapp
    AddType application/xml                     xml xsl
    AddType audio/ogg                           oga ogg
    AddType image/webp                          webp
    AddType image/x-icon                        ico
    # Offline cache http://dev.w3.org/html5/spec-preview/iana.html#text/cache-manifest, https://developer.mozilla.org/en-US/docs/Web/HTML/Using_the_application_cache
    AddType text/cache-manifest                 appcache
    AddType text/vtt                            vtt
    AddType text/vcard                          vcard vcf
    AddType video/mp4                           mp4
    AddType video/ogg                           ogv
    AddType video/webm                          webm
</IfModule>

<IfModule deflate_module>
    # Gzip compression
    <IfModule setenvif_module>
        <IfModule headers_module>
            SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
            RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
        </IfModule>
    </IfModule>
    <IfModule filter_module>
        AddOutputFilterByType DEFLATE "application/font-sfnt \
                                      "application/font-woff" \
                                      "application/font-woff2" \
                                      "application/javascript" \
                                      "application/json" \
                                      "application/manifest+json" \
                                      "application/rss+xml" \
                                      "application/vnd.ms-fontobject" \
                                      "application/x-chrome-extension" \
                                      "application/x-navigator-extension" \
                                      "application/x-web-app-manifest+json" \
                                      "application/xhtml+xml" \
                                      "application/xml" \
                                      "application/xslt+xml" \
                                      "image/svg+xml" \
                                      "image/x-icon" \
                                      "text/cache-manifest" \
                                      "text/css" \
                                      "text/html" \
                                      "text/plain" \
                                      "text/vcard" \
                                      "text/vtt"
    </IfModule>
</IfModule>

<IfModule expires_module>
    # Improve better cache control
    ExpiresActive On
    ExpiresDefault                                    "access plus 1 month"
    ExpiresByType application/font-sfnt               "access plus 1 year"
    ExpiresByType application/font-woff               "access plus 1 year"
    ExpiresByType application/font-woff2              "access plus 1 year"
    ExpiresByType application/javascript              "access plus 1 year"

    # Cache Ajax http://developer.yahoo.com/performance/rules.html#cacheajax
    ExpiresByType application/json                    "access plus 1 day"
    ExpiresByType application/manifest+json           "access plus 1 month"

    ExpiresByType application/rss+xml                 "access plus 1 day"
    ExpiresByType application/vnd.ms-fontobject       "access plus 1 year"
    ExpiresByType application/x-chrome-extension      "access plus 1 month"
    ExpiresByType application/x-navigator-extension   "access plus 1 month"
    ExpiresByType application/x-web-app-manifest+json "access plus 1 month"
    ExpiresByType application/xml                     "access plus 1 day"
    ExpiresByType application/xslt+xml                "access plus 1 year"
    ExpiresByType audio/ogg                           "access plus 1 year"
    ExpiresByType image/gif                           "access plus 1 year"
    ExpiresByType image/jpeg                          "access plus 1 year"
    ExpiresByType image/png                           "access plus 1 year"
    ExpiresByType image/svg+xml                       "access plus 1 month"
    ExpiresByType image/x-icon                        "access plus 1 month"
    ExpiresByType text/cache-manifest                 "access plus 0 seconds"
    ExpiresByType text/css                            "access plus 1 year"
    ExpiresByType text/html                           "access plus 1 day"
    ExpiresByType text/plain                          "access plus 1 month"
    ExpiresByType text/vcard                          "access plus 1 month"
    ExpiresByType text/vtt                            "access plus 1 month"
    ExpiresByType video/mp4                           "access plus 1 year"
    ExpiresByType video/ogg                           "access plus 1 year"
    ExpiresByType video/webm                          "access plus 1 year"
</IfModule>

<IfModule headers_module>
    # Execute as PHP file
    <FilesMatch ^(humans\.txt|manifest\.appcache|manifest\.json|robots\.txt|sitemap\.xml|sitemap\.xsl)$>
        SetHandler application/x-httpd-php
    </FilesMatch>
    # Correct MIME type
    <FilesMatch ^(humans|robots)\.txt$>
        Header set Content-Type "text/plain"
    </FilesMatch>
    <FilesMatch ^manifest\.appcache$>
        Header set Content-Type "text/cache-manifest"
    </FilesMatch>
    <FilesMatch ^manifest\.json$>
        # Chrome Manifest https://developer.chrome.com/apps/manifest, https://developer.chrome.com/extensions/manifest
        Header set Content-Type "application/manifest+json"

        <IfModule expires_module>
            ExpiresDefault "access plus 1 month"
        </IfModule>
    </FilesMatch>
    <FilesMatch ^sitemap\.(xml|xsl)$>
        Header set Content-Type "application/xml"
    </FilesMatch>

    # Do not show a snippet in the search results for this files
    <FilesMatch \.(css|js|json|txt|xml|xsl)$>
        # CSS and JS files must stay indexable/crawlable in order to allow search engines to render the pages like a modern browser http://googlewebmastercentral.blogspot.com/2014/05/understanding-web-pages-better.html
        Header set X-Robots-Tag nosnippet
    </FilesMatch>

    # # CORS file access from all domains
    # <IfModule setenvif_module>
    #     <FilesMatch \.(eot|gif|ico|jpe?g|otf|png|svg|ttf|webp|woff|woff2)$>
    #         SetEnvIf Origin ":" IS_CORS
    #         Header set Access-Control-Allow-Origin "*" env=IS_CORS
    #     </FilesMatch>
    # </IfModule>

    Header unset ETag

    # No need for Vary header till served different code/URLs to different User-Agent's https://developers.google.com/webmasters/mobile-sites/mobile-seo/overview/select-config
    Header unset Vary
</IfModule>

FileETag None

# Use UTF-8 encoding for anything served as text/plain or text/html
AddDefaultCharset utf-8

ErrorDocument 403 "403 Forbidden"
ErrorDocument 404 "404 Not Found"
ErrorDocument 500 "500 Internal Server Error"

EnableMMAP Off

<IfModule mpm_worker_module>
    StartServers           2
    MaxRequestWorkers      150
    MinSpareThreads        15
    MaxSpareThreads        50
    ThreadsPerChild        15
    MaxConnectionsPerChild 0
</IfModule>
<IfModule mpm_event_module>
    StartServers           2
    MaxRequestWorkers      150
    MinSpareThreads        15
    MaxSpareThreads        50
    ThreadsPerChild        15
    MaxConnectionsPerChild 0
</IfModule>
<IfModule mpm_prefork_module>
    StartServers           2
    MinSpareServers        2
    MaxSpareServers        5
    ServerLimit            100
    MaxRequestWorkers      100
    MaxConnectionsPerChild 500
</IfModule>

<IfModule security2_module>
    # Mask Server signature http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.38, https://www.ietf.org/rfc/rfc2616.txt
    SecServerSignature " "
</IfModule>

# Load config files
Include httpd-*.conf

<IfModule headers_module>
    <IfModule setenvif_module>
        # Prevent clickjacking, block display in <frame>, <iframe> and <object>
        Header set X-Frame-Options DENY

        # Force IE in highest available mode http://expression.microsoft.com/en-us/dd835379.aspx
        BrowserMatch MSIE ie
        Header set X-UA-Compatible IE=edge env=ie

        # Remove cross-site scripting attacks on IE8 and IE9 http://technet.microsoft.com/en-us/security/bulletin/MS10-002#section6
        BrowserMatch "MSIE [8-9]" ie89
        Header set X-XSS-Protection "1; mode=block" env=ie89
    </IfModule>
    <FilesMatch \.(appcache|crx|css|eot|gif|ico|jpe?g|js|mp4|oga|ogg|ogv|otf|pdf|png|svg|ttf|txt|vcard|vcf|nex|webapp|webm|webmanifest|webp|woff|woff2|xml|xsl)$>
        # Unset only HTML document related headers
        #
        Header unset X-Frame-Options
        Header unset Strict-Transport-Security env=SSL

        <IfModule setenvif_module>
            Header unset X-UA-Compatible env=ie
            Header unset X-XSS-Protection env=ie89
        </IfModule>
    </FilesMatch>
</IfModule>

# Configures optimizations for a Protocol's Listener Sockets
AcceptFilter http none
# AcceptFilter https none

<IfModule http2_module>
    # Enable HTTP/2
    ProtocolsHonorOrder On

    # Enable the HTTP/2 protocol
    # for a https server
    Protocols h2 http/1.1
    # for a http server, bug https://bz.apache.org/bugzilla/show_bug.cgi?id=58437 (httpd v2.5)
    Protocols h2c http/1.1

    H2Direct on

    LogLevel http2:info
</IfModule>
